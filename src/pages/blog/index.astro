---
import BaseLayout from "@layout/BaseLayout.astro";

import { getCollection } from "astro:content";
import { withBase } from "@utils/paths";
import { formatDate } from "@utils/utils";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

const posts = (await getCollection("blog")).toSorted(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

const authorImages = import.meta.glob<{
  default: ImageMetadata;
}>("../../assets/images/blog/authors/*.{png,svg,jpg,jpeg,webp,avif}", {
  eager: true,
});

const slugify = (value: string) =>
  value
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");

const getAuthorImage = (name: string) => {
  const slug = slugify(name);
  const extensions = ["png", "svg", "jpg", "jpeg", "webp", "avif"];
  for (const ext of extensions) {
    const match =
      authorImages[`../../assets/images/blog/authors/${slug}.${ext}`];
    if (match) {
      return match.default;
    }
  }
  return null;
};

export const pageContent = {
  pageTitle: "Field notes on AI that ships",
  subTitle: "Practical lessons from AI deployments in complex, regulated environments.",
  actionLabel: "Read more",
};
---

<BaseLayout>
  <section class="mx-auto max-w-340 px-4 pb-12 pt-48 sm:px-6 lg:px-8">
    <div class="max-w-7xl">
      <div class="mx-auto max-w-3xl lg:mx-0">
        <h1
          class="text-balance text-4xl text-slate-800 sm:text-5xl md:text-6xl lg:text-7xl"
        >
          {pageContent.pageTitle}
        </h1>
        <p class="mt-6 text-lg text-slate-600">
          {pageContent.subTitle}
        </p>
      </div>
    </div>
  </section>
  <section class="mx-auto max-w-340 px-4 py-10 sm:px-6 md:py-10 lg:px-8 lg:py-10">
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 xl:grid-cols-3">
      {
        posts.map((item) => {
          const slug =
            "slug" in item ? (item as typeof item & { slug: string }).slug : item.id;
          const authorImage = getAuthorImage(item.data.author);
          const authorInitials = item.data.author
            .split(/\s+/)
            .filter(Boolean)
            .map((word) => word[0]?.toUpperCase() ?? "")
            .join("")
            .slice(0, 2);
          const clampStyle = (lines: number) =>
            `display:-webkit-box;-webkit-line-clamp:${lines};-webkit-box-orient:vertical;overflow:hidden;`;

          return (
            <a
              class="group"
              href={withBase(`/blog/${slug}`)}
              aria-label={`Read ${item.data.title}`}
            >
              <article
                class="flex h-full flex-col rounded-2xl border border-slate-200 bg-white/85 p-6 shadow-sm transition duration-300 hover:-translate-y-1 hover:border-indigo-200 hover:shadow-lg dark:border-slate-700 dark:bg-slate-900/80"
              >
                <h3
                  class="text-xl font-semibold text-slate-900 transition duration-300 group-hover:text-indigo-700 dark:text-white"
                  style={clampStyle(2)}
                >
                  {item.data.title}
                </h3>
                <div class="mt-3 flex flex-wrap gap-2">
                  {item.data.tags.map((tag) => (
                    <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600 dark:bg-slate-800/60 dark:text-slate-200">
                      {tag}
                    </span>
                  ))}
                </div>
                <p
                  class="mt-4 text-sm leading-6 text-slate-600 dark:text-slate-300"
                  style={clampStyle(3)}
                >
                  {item.data.description}
                </p>
                <div class="mt-8 flex items-center justify-between gap-4">
                  <div class="flex items-center gap-3">
                    {
                      authorImage ? (
                        <Image
                          class="size-[46px] rounded-full border-2 border-white/80 shadow-sm dark:border-slate-700"
                          src={authorImage}
                          alt={item.data.author}
                          width={46}
                          height={46}
                          loading="lazy"
                        />
                      ) : (
                        <div class="flex size-[46px] items-center justify-center rounded-full border-2 border-white/80 bg-indigo-100 text-sm font-semibold text-indigo-700 dark:border-slate-700 dark:bg-indigo-900/40 dark:text-indigo-200">
                          {authorInitials}
                        </div>
                      )
                    }
                    <div>
                      <p class="text-sm font-semibold text-slate-800 dark:text-slate-100">{item.data.author}</p>
                      <time datetime={item.data.date.toISOString()} class="text-xs text-slate-400 dark:text-slate-400">
                        {formatDate(item.data.date)}
                      </time>
                    </div>
                  </div>
                  <span class="inline-flex items-center text-sm font-semibold text-indigo-600 dark:text-indigo-400">
                    {pageContent.actionLabel}
                    <svg
                      class="ms-1 size-4"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M5 12h14" />
                      <path d="m12 5 7 7-7 7" />
                    </svg>
                  </span>
                </div>
              </article>
            </a>
          );
        })
      }
    </div>
  </section>
</BaseLayout>
