---
import { getCollection } from "astro:content";
import { withBase } from "@utils/paths";
import { formatDate } from "@utils/utils";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

// Get the 3 most recent blog posts
const posts = (await getCollection("blog"))
  .toSorted((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);

const authorImages = import.meta.glob<{
  default: ImageMetadata;
}>("../../assets/images/blog/authors/*.{png,svg,jpg,jpeg,webp,avif}", {
  eager: true,
});

const slugify = (value: string) =>
  value
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");

const getAuthorImage = (name: string) => {
  const slug = slugify(name);
  const extensions = ["png", "svg", "jpg", "jpeg", "webp", "avif"];
  for (const ext of extensions) {
    const match =
      authorImages[`../../assets/images/blog/authors/${slug}.${ext}`];
    if (match) {
      return match.default;
    }
  }
  return null;
};
---

<section class="bg-off-white py-16 dark:bg-slate-950 sm:py-24">
  <div class="mx-auto max-w-[85rem] px-4 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-4xl text-center">
      <p class="text-sm font-semibold uppercase tracking-[0.3em] text-indigo-600 dark:text-indigo-300">
        Latest Research
      </p>
      <h2 class="mt-4 text-3xl font-semibold text-slate-900 sm:text-4xl dark:text-white">
        AI Insights from the Field
      </h2>
      <p class="mt-4 text-lg text-slate-600 dark:text-slate-300">
        Practical lessons and research on deploying Generative AI and agentic systems in enterprise environments.
      </p>
    </div>

    <div class="mt-12 grid gap-6 sm:grid-cols-1 lg:grid-cols-3">
      {posts.map((item) => {
        const slug =
          "slug" in item ? (item as typeof item & { slug: string }).slug : item.id;
        const authorImage = getAuthorImage(item.data.author);
        const authorInitials = item.data.author
          .split(/\s+/)
          .filter(Boolean)
          .map((word) => word[0]?.toUpperCase() ?? "")
          .join("")
          .slice(0, 2);

        return (
          <a
            class="group"
            href={withBase(`/blog/${slug}`)}
            aria-label={`Read ${item.data.title}`}
          >
            <article
              class="flex h-full flex-col rounded-2xl border border-slate-200 bg-white/85 p-6 shadow-sm transition duration-300 hover:-translate-y-1 hover:border-indigo-200 hover:shadow-lg dark:border-slate-800 dark:bg-slate-900/80"
            >
              <div class="flex flex-wrap gap-2">
                {item.data.tags.map((tag) => (
                  <span class="rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300">
                    {tag}
                  </span>
                ))}
              </div>

              <h3
                class="mt-4 text-xl font-semibold text-slate-900 transition duration-300 group-hover:text-indigo-700 dark:text-white"
              >
                {item.data.title}
              </h3>

              <p
                class="mt-3 text-sm leading-6 text-slate-600 dark:text-slate-300 line-clamp-3"
              >
                {item.data.description}
              </p>

              <div class="mt-auto pt-6">
                <div class="flex items-center justify-between gap-4">
                  <div class="flex items-center gap-3">
                    {
                      authorImage ? (
                        <Image
                          class="size-8 rounded-full border-2 border-white/80 shadow-sm dark:border-slate-700"
                          src={authorImage}
                          alt={item.data.author}
                          width={32}
                          height={32}
                          loading="lazy"
                        />
                      ) : (
                        <div class="flex size-8 items-center justify-center rounded-full border-2 border-white/80 bg-indigo-100 text-xs font-semibold text-indigo-700 dark:border-slate-700 dark:bg-indigo-900/40 dark:text-indigo-200">
                          {authorInitials}
                        </div>
                      )
                    }
                    <div>
                      <p class="text-sm font-semibold text-slate-800 dark:text-slate-100">{item.data.author}</p>
                      <time datetime={item.data.date.toISOString()} class="text-xs text-slate-400 dark:text-slate-400">
                        {formatDate(item.data.date)}
                      </time>
                    </div>
                  </div>
                </div>
              </div>
            </article>
          </a>
        );
      })}
    </div>

    <div class="mt-10 text-center">
      <a
        href={withBase("/blog")}
        class="inline-flex items-center text-base font-semibold text-indigo-700 transition hover:text-indigo-500 dark:text-indigo-300"
      >
        View all AI insights
        <svg
          class="ms-2 size-4"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M5 12h14" />
          <path d="m12 5 7 7-7 7" />
        </svg>
      </a>
    </div>
  </div>
</section>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>